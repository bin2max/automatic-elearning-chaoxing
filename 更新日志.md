# 更新日志

## v1.2.1 (2024-01-XX)

### 🆕 新增功能
- **fullScreenContainer播放按钮定位**: 精确定位在fullScreenContainer内的播放按钮
- **多重点击方法**: 提供直接点击、JavaScript点击、onclick事件三种点击方式
- **智能元素交互**: 自动处理元素不可交互的问题

### 🔧 改进功能
- **播放按钮查找策略优化**: 优先在fullScreenContainer内查找播放按钮
- **调试功能增强**: 新增fullScreenContainer元素检查
- **错误处理完善**: 提供更详细的错误信息和解决方案

### 🐛 修复问题
- 修复了播放按钮无法找到的问题
- 修复了元素不可交互的错误
- 优化了课程点击的成功率

---

## v1.2.0 (2024-01-XX)

### 🆕 新增功能
- **精确的未完成课程识别**: 使用XPath精确定位带有待完成任务点的课程
- **智能课程状态检测**: 通过检查课程后面的catalog_points_yi元素来判断完成状态
- **备用执行机制**: 当元素点击失败时，自动尝试通过onclick事件执行

### 🔧 改进功能
- **课程查找算法优化**: 直接从页面查找未完成课程，不再依赖章节展开
- **调试工具增强**: 更新调试脚本，提供更详细的页面结构分析
- **学习流程简化**: 简化了课程学习流程，提高了成功率

### 🐛 修复问题
- 修复了无法找到未完成课程的问题
- 修复了章节展开导致的stale element问题
- 优化了课程状态检测的准确性

---

## v1.1.1 (2024-01-XX)

### 🆕 新增功能
- **ChromeDriver自动下载工具**: 新增ChromeDriver下载脚本，解决版本兼容性问题
- **多重驱动获取策略**: 程序现在会尝试多种方式获取ChromeDriver
- **智能错误处理**: 增强了ChromeDriver相关的错误处理和提示

### 🔧 改进功能
- **浏览器驱动设置优化**: 改进了ChromeDriver的获取和设置逻辑
- **跨平台支持**: 支持Windows、macOS和Linux系统
- **用户友好的错误提示**: 提供详细的错误信息和解决方案

### 🐛 修复问题
- 修复了Chrome 138+版本ChromeDriver兼容性问题
- 修复了webdriver-manager无法获取最新驱动的问题

---

## v1.1.0 (2024-01-XX)

### 🆕 新增功能
- **人脸识别弹窗自动关闭**: 程序现在能够自动检测并点击人脸识别弹窗的关闭按钮
- **页面加载等待**: 添加了页面加载完成的等待机制
- **动态课程列表更新**: 学习完一个课程后会自动重新获取未完成课程列表

### 🔧 改进功能
- **学习流程优化**: 改进了课程学习的循环逻辑，确保所有课程都能被正确识别和学习
- **错误处理增强**: 增强了人脸识别弹窗处理的错误处理机制
- **日志记录完善**: 添加了更详细的操作日志记录

### 🐛 修复问题
- 修复了人脸识别弹窗出现后程序无法继续的问题
- 修复了课程完成后状态更新不及时的问题

### 📝 技术细节
- 新增选择器: `face_close_button: "a.popClose.fr"`
- 新增方法: `close_face_recognition_popup()` 和 `wait_for_page_load()`
- 更新了工具函数，添加了 `handle_face_recognition_popup()` 函数

---

## v1.0.0 (2024-01-XX)

### 🎉 初始版本
- **自动登录**: 自动填写用户名和密码登录超星平台
- **智能识别**: 自动识别未完成的课程和章节
- **自动播放**: 自动点击播放按钮开始学习
- **速度调节**: 自动设置播放速度为2倍速
- **人脸识别**: 自动检测人脸识别弹窗
- **进度跟踪**: 实时显示学习进度和状态
- **日志记录**: 详细的操作日志记录

### 📋 基础功能
- Chrome浏览器自动化控制
- 课程目录智能扫描
- 视频播放器操作
- 播放速度自动调节
- 学习状态实时监控

---

## 使用说明

### 更新方法
1. 下载最新版本的程序文件
2. 替换原有的 `chaoxing_auto_learner.py` 和 `config.py` 文件
3. 重新运行程序即可享受新功能

### 注意事项
- 新版本完全兼容旧版本的配置文件
- 建议在更新前备份原有的配置文件
- 如果遇到问题，可以查看日志文件进行故障排除

---

## v1.2.2 (2025-08-04)
### 新增
- 添加iframe处理功能，自动检测并切换到包含视频播放器的iframe
- 添加 `switch_to_video_iframe()` 方法
- 更新播放按钮查找逻辑，支持iframe上下文
- 添加深度分析脚本 `deep_analyze.py`
- 添加页面源码保存脚本 `save_page_source.py`

### 改进
- 改进调试功能，显示当前iframe上下文信息
- 优化元素查找策略，优先在iframe中查找视频元素

## v1.2.3 (2025-08-04)
### 修复
- **修复嵌套iframe问题**：视频播放器在嵌套iframe中（主iframe → 视频iframe）
- 更新iframe处理逻辑，支持三层iframe结构
- 添加嵌套iframe测试脚本 `test_nested_iframe.py`

### 改进
- 智能检测主iframe（id="iframe"）和视频iframe（class包含"ans-insertvideo-online"）
- 自动切换到正确的iframe上下文
- 优化播放按钮查找和点击逻辑

### 技术细节
- 主文档 → 主iframe（id="iframe"） → 视频iframe（class="ans-insertvideo-online"）
- 播放按钮位于视频iframe中
- 支持自动iframe切换和恢复

## v1.2.4 (2025-08-04)
### 修复
- **修复播放按钮点击问题**：统一主程序与测试程序的播放按钮处理逻辑
- 简化播放按钮查找逻辑，直接使用 `.vjs-big-play-button` 选择器
- 修复iframe上下文切换问题，确保在正确的iframe中点击播放按钮

### 改进
- 优化播放按钮状态检查，确保按钮可见且可点击
- 改进错误处理，提供更详细的播放按钮信息
- 统一iframe处理逻辑，与测试程序保持一致

### 技术细节
- 移除复杂的fullScreenContainer查找逻辑
- 直接在视频iframe中查找播放按钮
- 确保在正确的iframe上下文中执行点击操作

## v1.2.5 (2025-08-04)
### 修复
- **修复iframe上下文问题**：解决播放速度设置、导航目录、人脸识别弹窗检测失败的问题
- 在所有需要操作主文档元素的方法中添加iframe上下文检查
- 自动切回主文档执行操作，避免在iframe中查找主文档元素

### 改进
- 优化播放速度设置逻辑，确保在主文档中查找播放速度控制
- 改进导航目录功能，自动切回主文档查找目录按钮
- 完善人脸识别弹窗处理，确保在主文档中检测和关闭弹窗
- 在学习完成后自动切回主文档，准备下一个课程

### 技术细节
- 添加iframe上下文检查：`self.driver.execute_script("return window.frameElement;")`
- 自动iframe切换：`self.driver.switch_to.default_content()`
- 统一iframe处理策略：在需要操作主文档元素时自动切回主文档

## v1.2.6 (2025-08-04)
### 改进
- **优化课程完成判断逻辑**：从单一的人脸识别弹窗检测改为多种判断方式
- 添加视频播放状态检查，当视频播放到95%以上时认为完成
- 增加固定等待时间作为最后的备用判断方法
- 提高课程完成判断的准确性和可靠性

### 新增功能
- `wait_for_course_completion()` 方法：综合多种方式判断课程完成
- 视频播放进度监控：检查视频的currentTime和duration
- 多层级完成判断：人脸识别弹窗 → 视频播放状态 → 固定等待时间

### 技术细节
- 方法1：等待人脸识别弹窗（主要方法）
- 方法2：检查视频播放状态（备用方法，播放到95%以上）
- 方法3：固定等待30秒（最后备用方法）
- 确保在各种情况下都能正确判断课程完成状态

## v1.2.7 (2025-08-04)
### 修复
- **修复人脸识别弹窗检测问题**：根据用户提供的HTML结构更新选择器
- 将人脸识别弹窗选择器从 `div.faceCollectQrPopVideo` 更新为 `div.maskDiv1.chapterVideoFaceQrMaskDiv`
- 解决人脸识别弹窗无法检测到的问题
- **修复ChromeDriver路径问题**：优先使用项目根目录的 `chromedriver.exe` 文件

### 新增功能
- `save_face_recognition_page.py`：专门保存人脸识别弹窗页面源码的脚本
- `save_face_recognition_page.bat`：运行人脸识别弹窗页面保存脚本的批处理文件
- 支持手动触发人脸识别弹窗后保存页面源码进行分析

### 技术细节
- 更新 `config.py` 中的人脸识别弹窗选择器
- 添加多种人脸识别相关元素的分析
- 支持保存主文档和所有iframe的源码
- 提供详细的人脸识别元素分析日志
- 优化ChromeDriver获取策略：本地文件 → webdriver-manager → 系统PATH → Chrome for Testing

## v1.2.8 (2025-08-04)
### 改进
- **优化人脸识别弹窗检测逻辑**：基于保存的页面源码分析结果
- 增强弹窗可见性检查，确保弹窗真正显示（display: block）
- 改进关闭弹窗的多种方法，提高成功率

### 技术细节
- 添加弹窗可见性检查：`face_recognition.is_displayed()`
- 等待弹窗变为可见状态：`WebDriverWait` 检查 `is_displayed()`
- 多种关闭弹窗方法：
  - 方法1：直接点击关闭按钮
  - 方法2：执行 `window.location.reload()` 脚本
  - 方法3：JavaScript点击关闭按钮
- 增加关闭操作的错误处理和重试机制

## v1.2.9 (2025-08-04)
### 修复
- **修复人脸识别弹窗等待时间过短问题**：将等待时间从3秒增加到60秒
- **优化人脸识别弹窗检测逻辑**：使用 `EC.and_` 同时检查元素存在和可见性
- **改进视频播放状态检查**：增加详细的视频播放进度日志

### 新增配置
- `FACE_RECOGNITION_TIMEOUT = 60`：人脸识别弹窗等待超时时间（秒）
- `PLAYBACK_SPEED_WAIT = 5`：播放速度设置前等待时间（秒）

### 技术细节
- 使用专门的 `WebDriverWait` 等待人脸识别弹窗，超时时间60秒
- 使用 `EC.and_(EC.presence_of_element_located, EC.visibility_of_element_located)` 确保弹窗存在且可见
- 增加视频播放状态的详细日志，包括当前时间和总时长
- 优化错误处理和日志输出，提供更清晰的执行状态信息

## v1.3.0 (2025-08-04)
### 修复
- **修复Selenium API错误**：将 `EC.and_` 改为正确的 `EC.all_of`
- **改进课程完成判断逻辑**：只有真正检测到人脸识别弹窗才认为课程完成
- **移除固定等待时间判断**：不再使用30秒固定等待作为课程完成判断

### 改进
- **增加详细调试信息**：在课程完成检测流程中增加更多日志
- **优化异常处理**：改进错误处理和返回值逻辑
- **增强日志可读性**：使用emoji和更清晰的日志格式

### 技术细节
- 修复 `EC.all_of` 替代错误的 `EC.and_` API
- 人脸识别弹窗检测失败时返回 `False` 而不是继续其他方法
- 移除可能导致误判的固定等待时间判断
- 增加配置参数显示和检测流程的详细日志
- 改进课程学习完成状态的返回值处理

## v1.3.1 (2025-08-04)
### 修复
- **增强人脸识别弹窗检测**：添加多个备用选择器和详细调试信息
- **改进弹窗检测逻辑**：增加文档上下文检查和元素状态分析

### 新增功能
- **多级备用选择器**：
  - 主选择器：`div.maskDiv1.chapterVideoFaceQrMaskDiv`
  - 备用选择器1：只检查元素存在性
  - 备用选择器2：`div.maskDiv1`
  - 备用选择器3：`[class*='chapterVideoFaceQrMaskDiv']`
- **详细调试信息**：显示当前文档上下文、元素可见性、样式属性等

### 技术细节
- 增加文档上下文检查（是否在iframe中）
- 显示弹窗元素的详细属性（可见性、样式、类名）
- 实现多级备用选择器机制，提高检测成功率
- 优化调试日志，便于问题排查

## v1.3.2 (2025-08-04)
### 修复
- **全面增强人脸识别弹窗检测**：基于保存的页面源码分析，实现更准确的检测
- **添加JavaScript检测方法**：使用JavaScript直接检查DOM元素状态

### 新增功能
- **多选择器全面检查**：
  - 检查5种不同的CSS选择器
  - 显示每个选择器的检测结果
  - 页面源码文本检查
- **JavaScript检测方法**：
  - 使用JavaScript直接查询DOM
  - 检查元素的display和offsetParent属性
  - 更准确的可见性判断

### 技术细节
- 实现5级检测机制：主选择器 → 备用选择器1 → 备用选择器2 → 备用选择器3 → JavaScript检测
- 增加页面源码文本检查，确认元素是否在页面中
- 使用JavaScript检查元素的真实可见性状态
- 优化调试信息，提供更详细的检测过程日志

## v1.3.3 (2025-08-04)
### 修复
- **基于实际元素信息优化检测**：根据用户提供的真实元素属性信息改进选择器
- **增加更多备用选择器**：添加基于实际class的选择器

### 新增功能
- **基于实际元素的选择器**：
  - `div.popDiv1`：基于实际元素的class
  - `[class*='faceCollectQrPopVideo']`：基于实际元素的class
  - `[class*='faceRecognition_0']`：基于实际元素的class
- **增强JavaScript检测**：
  - 检查更多选择器组合
  - 增加元素尺寸检查（offsetWidth > 0 && offsetHeight > 0）
  - 添加详细的console.log调试信息
- **最终检测方法**：
  - 通过页面文本内容检测人脸识别弹窗
  - 检查"人脸信息采集"、"请使用手机APP采集人脸信息"等关键词

### 技术细节
- 基于用户提供的实际元素属性信息优化选择器
- 实现6级检测机制：主选择器 → 备用选择器1-3 → JavaScript检测 → 文本检测
- 增加元素尺寸和可见性的综合判断
- 提供更详细的JavaScript调试信息

## v1.4.0 (2025-08-04)
### 重大改进
- **重新设计课程完成检测逻辑**：从单次检测改为持续监控模式
- **分离视频状态检测和人脸识别检测**：独立检查视频播放状态和弹窗出现

### 新增功能
- **持续监控机制**：
  - 每30秒检查一次课程状态
  - 同时监控视频播放状态和人脸识别弹窗
  - 支持长时间视频播放（最长1800秒）
- **视频状态检测**：
  - `check_video_status()`：检查视频播放进度、暂停状态、完成状态
  - 支持检测视频是否播放完成（currentTime >= duration - 1）
- **人脸识别弹窗检测**：
  - `check_face_recognition_popup()`：独立检测弹窗是否存在
  - 使用8种选择器组合检测
  - 支持页面文本内容检测

### 技术细节
- 实现持续监控循环，每5秒检查一次弹窗，每30秒检查一次视频状态
- 分离关注点：视频播放状态和人脸识别弹窗独立检测
- 支持超时机制：总等待时间1800秒，超时后认为课程完成
- 优化日志输出：显示等待时间和检测状态

## v1.4.1 (2025-08-04)
### 修复
- **修复等待时间配置错误**：将 `FACE_RECOGNITION_WAIT` 从1740秒改为3秒
- **优化课程完成处理逻辑**：检测到弹窗后立即关闭，不再长时间等待

### 改进
- **优化主程序运行逻辑**：
  - 改进学习进度显示，包含课程标题
  - 增加页面稳定等待时间（5秒）
  - 优化日志输出，使用emoji图标
  - 显示剩余未完成课程数量
- **优化弹窗关闭流程**：
  - 检测到弹窗后立即关闭（3秒稳定等待）
  - 明确提示准备学习下一个课程
  - 即使关闭失败也继续下一个课程

### 技术细节
- 修复配置参数：`FACE_RECOGNITION_WAIT = 3秒`（弹窗稳定等待）
- 保持 `FACE_RECOGNITION_TIMEOUT = 1800秒`（总等待时间）
- 优化课程循环逻辑，确保每个课程完成后正确继续
- 增加详细的进度和状态日志

## v1.4.2 (2025-08-04)
### 修复
- **修复弹窗关闭逻辑错误**：按钮不可见时不再错误返回成功
- **基于源码分析优化关闭方法**：根据保存的人脸识别弹窗源码改进关闭逻辑

### 新增功能
- **多重关闭方法**：
  - 方法1：查找并点击关闭按钮（可见/不可见都尝试）
  - 方法2：直接执行 `window.location.reload()` 页面刷新
  - 方法3：尝试多种关闭按钮选择器
  - 方法4：JavaScript隐藏弹窗元素
- **改进错误处理**：
  - 关闭失败时继续等待，不立即返回失败
  - 详细的日志记录每种方法的尝试结果
  - 只有在所有方法都失败时才返回失败

### 技术细节
- 基于源码分析：关闭按钮为 `<a href="javascript:;" onclick="window.location.reload();" class="popClose fr">`
- 支持多种选择器：`a.popClose.fr`、`a[onclick*='window.location.reload']` 等
- 改进可见性检查：即使按钮不可见也尝试JavaScript点击
- 增加弹窗隐藏方法：通过CSS隐藏弹窗元素

## v1.4.3 (2025-08-04)
### 修复
- **修复弹窗关闭验证问题**：添加弹窗关闭成功验证，避免虚假成功报告
- **增加导航到课程目录作为最后手段**：当所有关闭方法都失败时，尝试导航到课程目录

### 新增功能
- **弹窗关闭验证机制**：
  - `verify_popup_closed()`：验证弹窗是否真正关闭
  - 检查弹窗元素是否仍然可见
  - 检查页面文本是否还包含人脸识别相关内容
  - 每种关闭方法后都进行验证
- **方法5：导航到课程目录**：
  - 当所有关闭方法都失败时的最后手段
  - 通过导航到课程目录来绕过弹窗问题
  - 确保程序能够继续运行

### 技术细节
- 实现双重验证：元素可见性检查 + 页面文本检查
- 支持8种弹窗选择器的验证
- 每种关闭方法后都进行验证，只有验证成功才返回True
- 增加导航到课程目录作为兜底方案

## v1.4.4 (2025-08-04)
### 修复
- **修复视频播放时误判弹窗问题**：实现综合判断逻辑，避免视频播放时误判人脸识别弹窗
- **改进弹窗检测逻辑**：优先检查弹窗元素可见性，避免页面文本残留导致的误判

### 新增功能
- **综合判断逻辑**：
  - 根据视频播放状态决定是否检查弹窗
  - 视频播放中：不检查弹窗，继续等待
  - 视频完成：检查弹窗并处理
  - 视频暂停：检查弹窗并处理
  - 视频状态未知：谨慎检查弹窗
- **改进弹窗检测**：
  - 优先检查弹窗元素可见性
  - 只有在隐藏元素中找到相关文本才认为是弹窗
  - 避免页面文本残留导致的误判

### 技术细节
- 实现视频状态驱动的弹窗检测逻辑
- 改进 `check_face_recognition_popup()` 方法，增加可见性优先检查
- 支持隐藏元素中文本的检测，避免误判
- 优化日志输出，明确显示检测逻辑和结果

---

**感谢您的使用！** 🎓 